<!DOCTYPE html>

<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SVS é…ç½®å›³ã‚¨ãƒ‡ã‚£ã‚¿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      background: #111827; 
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      grid-template-rows: repeat(12, 1fr);
      gap: 1px;
      background-color: #6b7280;
      width: min(95vw, 480px);
      aspect-ratio: 1;
    }
    .cell {
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: all 0.1s;
      white-space: pre-line;
      line-height: 1.1;
      user-select: none;
    }
    .cell.editable { cursor: pointer; }
    .cell.editable:hover { opacity: 0.8; }
    .cell.editable:active { transform: scale(0.95); }
    .castle-overlay {
      position: absolute;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #fecdd3;
      pointer-events: none;
    }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #1f2937;
      border-radius: 0.5rem;
      padding: 1rem;
      margin: 1rem;
      max-width: 24rem;
      width: 100%;
    }
    .alliance-btn {
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      font-weight: bold;
      font-size: 0.875rem;
      transition: all 0.1s;
      border: none;
      cursor: pointer;
    }
    .alliance-btn:hover { opacity: 0.8; }
    .alliance-btn:active { transform: scale(0.95); }
    .share-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: bold;
      color: white;
      border: none;
      cursor: pointer;
      transition: all 0.1s;
    }
    .share-btn:active { transform: scale(0.95); }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
  <div id="app" class="p-2 sm:p-4">
    <h1 class="text-white text-xl font-bold text-center mb-4">SVS é…ç½®å›³ã‚¨ãƒ‡ã‚£ã‚¿</h1>

```
<!-- ã‚°ãƒªãƒƒãƒ‰ -->
<div class="flex justify-center mb-4">
  <div class="relative bg-gray-500 p-px rounded" style="width: min(95vw, 480px); aspect-ratio: 1;">
    <div id="grid" class="grid-container"></div>
    <!-- å¤ªé™½åŸã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="castle-overlay" class="castle-overlay">
      <div class="text-center text-gray-700 font-bold" style="font-size: 0.7rem;">
        <div>å¤ªé™½åŸ</div>
        <div style="font-size: 0.6rem;">SUN CASTLE</div>
      </div>
    </div>
  </div>
</div>

<!-- å…±æœ‰ãƒœã‚¿ãƒ³ -->
<div class="flex justify-center mb-4">
  <button id="shareBtn" class="share-btn bg-blue-600 hover:bg-blue-500">
    ğŸ“‹ å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼
  </button>
</div>

<!-- èª¬æ˜ -->
<div class="text-center text-gray-400 text-xs mb-4 space-y-1">
  <p>ãƒ”ãƒ³ã‚¯: å¤ªé™½åŸ / ã‚°ãƒ¬ãƒ¼: ç·¨é›†ä¸å¯</p>
  <p>ã‚¿ãƒƒãƒ—ã—ã¦åŒç›Ÿã‚’é…ç½® â†’ URLã‚’å…±æœ‰</p>
</div>

<!-- å‡¡ä¾‹ -->
<div id="legend" class="flex flex-wrap justify-center gap-2 mb-4"></div>
```

  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->

  <div id="modal" class="modal-overlay" style="display: none;">
    <div class="modal" onclick="event.stopPropagation()">
      <h2 class="text-white text-lg font-bold mb-4 text-center">åŒç›Ÿã‚’é¸æŠ</h2>
      <div id="allianceButtons" class="grid grid-cols-2 gap-2"></div>
      <button id="cancelBtn" class="w-full mt-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500">
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </button>
    </div>
  </div>

  <script>
    // åŒç›Ÿãƒ‡ãƒ¼ã‚¿
    const ALLIANCES = [
      { id: 'WOS', name: 'WOS', color: '#ef4444', code: 'W' },
      { id: 'MAN', name: 'MAN', color: '#f97316', code: 'M' },
      { id: 'GRL', name: 'GRL', color: '#84cc16', code: 'G' },
      { id: 'FGT', name: 'FGT', color: '#22c55e', code: 'F' },
      { id: 'FeS', name: 'FeS', color: '#eab308', code: 'S' },
      { id: 'DA7', name: 'DA7', color: '#06b6d4', code: 'D' },
      { id: 'Aeg', name: 'Aeg', color: '#3b82f6', code: 'A' },
      { id: 'MOF', name: 'MOF', color: '#8b5cf6', code: 'O' },
      { id: 'NONE', name: 'æŒ‡å®šãªã—', color: '#9ca3af', code: 'N' },
      { id: 'EMPTY', name: 'ç©ºç™½', color: '#ffffff', code: '_' },
    ];

    const GRID_SIZE = 12;
    const CASTLE_START = 4;
    const CASTLE_END = 7;

    // åˆ¤å®šé–¢æ•°
    const isCannon = (row, col) => {
      const corners = [
        [CASTLE_START, CASTLE_START], [CASTLE_START, CASTLE_END],
        [CASTLE_END, CASTLE_START], [CASTLE_END, CASTLE_END],
      ];
      return corners.some(([r, c]) => r === row && c === col);
    };

    const isCastle = (row, col) => 
      row >= CASTLE_START && row <= CASTLE_END && col >= CASTLE_START && col <= CASTLE_END;

    const isGrayZone = (row, col) => {
      const inGrayArea = row >= CASTLE_START - 1 && row <= CASTLE_END + 1 && 
                         col >= CASTLE_START - 1 && col <= CASTLE_END + 1;
      return inGrayArea && !isCastle(row, col);
    };

    const isDirectionCannon = (row, col) =>
      (row === 3 && col === 3) || (row === 3 && col === 8) || 
      (row === 8 && col === 3) || (row === 8 && col === 8);

    const getDirectionLabel = (row, col) => {
      if (row === 3 && col === 3) return 'è¥¿ç ²å°\nWEST';
      if (row === 3 && col === 8) return 'åŒ—ç ²å°\nNORTH';
      if (row === 8 && col === 3) return 'å—ç ²å°\nSOUTH';
      if (row === 8 && col === 8) return 'æ±ç ²å°\nEAST';
      return null;
    };

    const isEditable = (row, col) => !isCastle(row, col) && !isGrayZone(row, col);

    // ã‚°ãƒªãƒƒãƒ‰ãƒ‡ãƒ¼ã‚¿
    let grid = [];
    let selectedCell = null;

    // åˆæœŸåŒ–
    const initGrid = () => {
      grid = [];
      for (let i = 0; i < GRID_SIZE; i++) {
        const row = [];
        for (let j = 0; j < GRID_SIZE; j++) {
          row.push('EMPTY');
        }
        grid.push(row);
      }
    };

    // URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰/ãƒ‡ã‚³ãƒ¼ãƒ‰
    const encodeGrid = () => {
      let result = '';
      for (let row = 0; row < GRID_SIZE; row++) {
        for (let col = 0; col < GRID_SIZE; col++) {
          if (isEditable(row, col)) {
            const alliance = ALLIANCES.find(a => a.id === grid[row][col]);
            result += alliance ? alliance.code : '_';
          }
        }
      }
      return result;
    };

    const decodeGrid = (code) => {
      initGrid();
      if (!code) return;
      
      let codeIndex = 0;
      for (let row = 0; row < GRID_SIZE; row++) {
        for (let col = 0; col < GRID_SIZE; col++) {
          if (isEditable(row, col) && codeIndex < code.length) {
            const char = code[codeIndex];
            const alliance = ALLIANCES.find(a => a.code === char);
            if (alliance) {
              grid[row][col] = alliance.id;
            }
            codeIndex++;
          }
        }
      }
    };

    // ã‚»ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«å–å¾—
    const getCellStyle = (row, col) => {
      if (isDirectionCannon(row, col)) return { bg: '#fca5a5', color: '#374151' };
      if (isCannon(row, col)) return { bg: '#fca5a5', color: '#374151' };
      if (isCastle(row, col)) return { bg: '#fecdd3', color: '#374151' };
      if (isGrayZone(row, col)) return { bg: '#d1d5db', color: '#374151' };
      
      const alliance = ALLIANCES.find(a => a.id === grid[row][col]);
      const bg = alliance ? alliance.color : '#ffffff';
      const darkText = ['EMPTY', 'FeS', 'NONE'].includes(grid[row][col]);
      return { bg, color: darkText ? '#374151' : '#ffffff' };
    };

    // ã‚»ãƒ«ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
    const getCellText = (row, col) => {
      const direction = getDirectionLabel(row, col);
      if (direction) return direction;
      if (isCannon(row, col)) return 'ç ²å°';
      if (isCastle(row, col)) return '';
      if (isGrayZone(row, col)) return '';
      const cell = grid[row][col];
      if (cell === 'EMPTY' || cell === 'NONE') return '';
      return cell;
    };

    // ã‚°ãƒªãƒƒãƒ‰æç”»
    const renderGrid = () => {
      const gridEl = document.getElementById('grid');
      gridEl.innerHTML = '';

      for (let row = 0; row < GRID_SIZE; row++) {
        for (let col = 0; col < GRID_SIZE; col++) {
          const cell = document.createElement('button');
          cell.className = 'cell';
          
          const castle = isCastle(row, col);
          const cannon = isCannon(row, col);
          const editable = isEditable(row, col);
          const direction = getDirectionLabel(row, col);

          // å¤ªé™½åŸå†…éƒ¨ï¼ˆç ²å°ä»¥å¤–ï¼‰ã¯é€æ˜
          if (castle && !cannon) {
            cell.style.backgroundColor = 'transparent';
            gridEl.appendChild(cell);
            continue;
          }

          const style = getCellStyle(row, col);
          cell.style.backgroundColor = style.bg;
          cell.style.color = style.color;
          cell.style.textShadow = style.color === '#ffffff' ? '1px 1px 1px rgba(0,0,0,0.5)' : 'none';
          cell.style.fontSize = direction ? '0.4rem' : cannon ? '0.45rem' : '0.65rem';
          cell.textContent = getCellText(row, col);

          if (editable) {
            cell.classList.add('editable');
            cell.onclick = () => openModal(row, col);
          }

          gridEl.appendChild(cell);
        }
      }

      // å¤ªé™½åŸã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ä½ç½®èª¿æ•´
      const overlay = document.getElementById('castle-overlay');
      const pct = (n) => (n / GRID_SIZE * 100);
      overlay.style.top = `calc(${pct(CASTLE_START)}% + 1px)`;
      overlay.style.left = `calc(${pct(CASTLE_START)}% + 1px)`;
      overlay.style.width = `calc(${pct(CASTLE_END - CASTLE_START + 1)}% - 1px)`;
      overlay.style.height = `calc(${pct(CASTLE_END - CASTLE_START + 1)}% - 1px)`;
    };

    // ãƒ¢ãƒ¼ãƒ€ãƒ«
    const openModal = (row, col) => {
      selectedCell = { row, col };
      document.getElementById('modal').style.display = 'flex';
    };

    const closeModal = () => {
      selectedCell = null;
      document.getElementById('modal').style.display = 'none';
    };

    const selectAlliance = (allianceId) => {
      if (selectedCell) {
        grid[selectedCell.row][selectedCell.col] = allianceId;
        renderGrid();
      }
      closeModal();
    };

    // åŒç›Ÿãƒœã‚¿ãƒ³ç”Ÿæˆ
    const renderAllianceButtons = () => {
      const container = document.getElementById('allianceButtons');
      ALLIANCES.forEach(alliance => {
        const btn = document.createElement('button');
        btn.className = 'alliance-btn';
        btn.style.backgroundColor = alliance.color;
        btn.style.color = ['FeS', 'EMPTY', 'NONE'].includes(alliance.id) ? '#374151' : '#ffffff';
        if (alliance.id === 'EMPTY') btn.style.border = '2px solid #6b7280';
        btn.textContent = alliance.name;
        btn.onclick = () => selectAlliance(alliance.id);
        container.appendChild(btn);
      });
    };

    // å‡¡ä¾‹ç”Ÿæˆ
    const renderLegend = () => {
      const container = document.getElementById('legend');
      ALLIANCES.filter(a => a.id !== 'EMPTY').forEach(alliance => {
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.style.backgroundColor = alliance.color;
        const span = document.createElement('span');
        span.style.color = ['FeS', 'NONE'].includes(alliance.id) ? '#374151' : '#ffffff';
        span.style.fontWeight = '500';
        span.textContent = alliance.name;
        item.appendChild(span);
        container.appendChild(item);
      });
    };

    // å…±æœ‰
    const share = async () => {
      const encoded = encodeGrid();
      const url = `${window.location.origin}${window.location.pathname}?d=${encoded}`;
      
      try {
        await navigator.clipboard.writeText(url);
        const btn = document.getElementById('shareBtn');
        btn.textContent = 'âœ“ URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
        btn.classList.remove('bg-blue-600');
        btn.classList.add('bg-green-600');
        setTimeout(() => {
          btn.textContent = 'ğŸ“‹ å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼';
          btn.classList.remove('bg-green-600');
          btn.classList.add('bg-blue-600');
        }, 2000);
      } catch (err) {
        prompt('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', url);
      }
    };

    // åˆæœŸåŒ–
    const init = () => {
      const params = new URLSearchParams(window.location.search);
      const data = params.get('d');
      
      if (data) {
        decodeGrid(data);
      } else {
        initGrid();
      }

      renderGrid();
      renderAllianceButtons();
      renderLegend();

      document.getElementById('shareBtn').onclick = share;
      document.getElementById('modal').onclick = closeModal;
      document.getElementById('cancelBtn').onclick = closeModal;
    };

    init();
  </script>

</body>
</html>
